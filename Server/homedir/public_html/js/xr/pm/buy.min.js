var XRPM=window.XRPM||{};
!function(d,g,e,h){XRPM.ProductBuy=XF.Element.newHandler({options:{price:0,currencyData:{},phrase:"xr_pm_buy_for_x",freePhrase:"xr_pm_get_free_now",purchaseType:"product_or_renewal"},canUseCoupons:!1,$coupons:null,$couponRow:null,$couponInput:null,$couponButton:null,$couponList:null,xhr:null,$extras:null,basePrice:0,extras:0,coupons:0,submitAfter:!1,init:function(){this.basePrice=parseFloat(this.options.price);var a=this.$target.find(".js-extras"),c=a.find('input[type="checkbox"]'),b=this;c.each(function(){var a=
d(this);a.is(":checked")&&(b.extras+=parseFloat(a.data("price")))});c.on("change",XF.proxy(this,"extraChange"));this.$extras=a;a=this.$target.find(".js-coupons");if(this.canUseCoupons=!!a.length){this.$coupons=a;this.$couponRow=this.$target.find(".js-coupon");this.$couponInput=this.$couponRow.find(".js-couponCode");this.$couponButton=this.$couponRow.find(".js-checkCoupon");this.$couponList=this.$couponRow.find(".js-couponList");this.$couponButton.on("click",XF.proxy(this,"recalcCoupons"));var f=this.$couponButton;
this.$couponInput.on("keypress",function(a){if(13===a.which)return a.preventDefault(),f.click(),!1});d(e).on("click",".js-deleteCoupon",XF.proxy(this,"deleteCoupon"));this.recalcCoupons()}else this.recalc()},recalcCoupons:function(a){if(this.canUseCoupons){a&&a.preventDefault();this.xhr&&this.xhr.abort();a=this.$couponRow.data("checker");var c=XF.getDefaultFormData(this.$target);this.xhr=XF.ajax("post",a,c,XF.proxy(this,"couponsChecked"),{skipDefaultSuccess:!0})}else this.recalc()},couponsChecked:function(a){this.xhr=
null;var c=this.$couponList,b=this.$couponInput;a.html.content&&(XF.setupHtmlInsert(a.html,function(a,b,d){c.html(a);d()}),this.$coupons.val(JSON.stringify(a.coupons)),this.coupons=a.discount,this.recalc(),b.val(""),this.xhr=null)},deleteCoupon:function(a){if(this.canUseCoupons){a=d(a.currentTarget).data("coupon-id");var c=JSON.parse(this.$coupons.val());delete c[a];this.$coupons.val(JSON.stringify(c));XF.hideTooltips();this.recalcCoupons()}},extraChange:function(a){a=d(a.currentTarget);a.is(":checked")?
this.extras+=parseFloat(a.data("price")):this.extras-=parseFloat(a.data("price"));this.recalcCoupons()},recalc:function(){var a=this.options.currencyData,c=a.format,b=a.precision,d=a.symbol;a=this.basePrice+this.extras-this.coupons;a=parseFloat(a).toFixed(b);0>a&&(a=0);c=XF.stringTranslate(c,{"{symbol}":d,"{value}":a});c=XF.phrase(this.options.phrase,{"{price}":c});b=this.$target.find(".js-payButton");b.find(".button-text").html(c);parseInt(a)?(b.prop("disabled",!1),b.removeClass("is-disabled")):
"extra"!==this.options.purchaseType||this.$extras.find('input[type="checkbox"]:checked').length?(b.prop("disabled",!1),b.removeClass("is-disabled"),b.find(".button-text").html(XF.phrase(this.options.freePhrase))):(b.prop("disabled",!0),b.addClass("is-disabled"))}});XF.Element.register("xrpm-product-buy","XRPM.ProductBuy")}(jQuery,window,document);