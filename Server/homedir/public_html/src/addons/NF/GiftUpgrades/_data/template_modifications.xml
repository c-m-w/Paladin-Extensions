<?xml version="1.0" encoding="utf-8"?>
<template_modifications>
  <modification type="public" template="account_upgrades" modification_key="nixfifty_giftUpgrades_giftUpgrade" description="Adds a gift button to available upgrades." execution_order="9" enabled="1" action="str_replace">
    <find><![CDATA[<xf:button type="submit" icon="purchase" />]]></find>
    <replace><![CDATA[<xf:if is="{{ $upgrade.canPurchase() }}">$0</xf:if>
<xf:if is="{{ $upgrade.canGift() }}">
	<xf:if is="{{ $upgrade.canPurchase() }}"><span class="inputGroup-splitter"></span></xf:if>
	<xf:button type="submit" name="gift" value="1" icon="nfgift">{{ phrase('nf_giftupgrades_gift') }}</xf:button>
</xf:if>]]></replace>
  </modification>
  <modification type="public" template="account_upgrades" modification_key="nixfifty_giftUpgrades_giftUpgradePurchased" description="Displays giftee information to the gifter." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:foreach loop="$available" value="$upgrade">
			<li class="primaryContent upgrade">
					<form action="{$payPalUrl}" method="post" class="upgradeForm">
						<div class="cost">{$upgrade.costPhrase}</div>
						<xen:if is="{$upgrade.length_unit} AND {$upgrade.recurring}">

							<input type="hidden" name="cmd" value="_xclick-subscriptions" />
							<input type="hidden" name="a3" value="{$upgrade.cost_amount}" />
							<input type="hidden" name="p3" value="{$upgrade.length_amount}" />
							<input type="hidden" name="t3" value="{$upgrade.lengthUnitPP}" />
							<input type="hidden" name="src" value="1" />
							<input type="hidden" name="sra" value="1" />

							<input type="submit" value="{xen:phrase subscribe}" class="button" />
						<xen:else />
							<input type="hidden" name="cmd" value="_xclick" />
							<input type="hidden" name="amount" value="{$upgrade.cost_amount}" />

							<input type="submit" value="{xen:phrase purchase}" class="button" />
						</xen:if>

						<input type="hidden" name="business" value="{$xenOptions.payPalPrimaryAccount}" />
						<input type="hidden" name="currency_code" value="{$upgrade.currency}" />
						<input type="hidden" name="item_name" value="{xen:phrase account_upgrade}: {$upgrade.title} ({$visitor.username})" />
						<input type="hidden" name="quantity" value="1" />
						<input type="hidden" name="no_note" value="1" />
						<input type="hidden" name="no_shipping" value="1" />
						<input type="hidden" name="custom" value="{$visitor.user_id},{$upgrade.user_upgrade_id},token,{$visitor.csrf_token_page}" />

						<input type="hidden" name="charset" value="utf-8" />
						<input type="hidden" name="email" value="{$visitor.email}" />

						<input type="hidden" name="return" value="{xen:link 'full:account/upgrade-purchase'}" />
						<input type="hidden" name="cancel_return" value="{xen:link 'full:index'}" />
						<input type="hidden" name="notify_url" value="{$xenOptions.boardUrl}/payment_callback.php" />
					</form>

					<div class="upgradeMain">
						<h4 class="title">{$upgrade.title}</h4>
						<xen:if is="{$upgrade.description}">
							<div class="description">{xen:raw $upgrade.description}</div>
						</xen:if>
					</div>
			</li>
		</xen:foreach>]]></find>
    <replace><![CDATA[$0
<xen:include template="nixfifty_account_upgrades_gift_purchased" />]]></replace>
  </modification>
  <modification type="public" template="account_upgrades" modification_key="nixfifty_giftUpgrades_hidePurchase" description="Hide purchase button from purchased upgrades." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<input type="submit" value="{xen:phrase purchase}" class="button" />]]></find>
    <replace><![CDATA[<xen:if is="{$upgrade.can_purchase}">$0</xen:if>]]></replace>
  </modification>
  <modification type="public" template="account_upgrades" modification_key="nixfifty_giftUpgrades_noAvailableUpgrades" description="Adds giftable upgrades even the user is not eligible to purchase upgrades for themselves." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:if is="{$purchased}">
	<div class="section">
		<h3 class="subHeading">{xen:phrase purchased_upgrades}</h3>
		<ul>
		<xen:foreach loop="$purchased" value="$upgrade">
			<li class="primaryContent">
				<div class="upgrade">
					<div class="upgradeForm">
						<xen:if is="{$upgrade.record.end_date}">
							<div>{xen:phrase expires}: <xen:datetime time="$upgrade.record.end_date" /></div>
						</xen:if>
						<xen:if is="{$upgrade.length_unit} AND {$upgrade.recurring}">
							<a href="{$payPalUrl}?cmd=_manage-paylist" class="button">{xen:phrase cancel_subscription}</a>
						</xen:if>
					</div>

					<div class="upgradeMain">
						<h4 class="title">{$upgrade.title}</h4>
						<xen:if is="{$upgrade.description}">
							<div class="description">{xen:raw $upgrade.description}</div>
						</xen:if>
					</div>
				</div>
			</li>
		</xen:foreach>
		</ul>
	</div>
</xen:if>]]></find>
    <replace><![CDATA[<xen:if is="!{$available}">
<div class="section">
	<h3 class="subHeading">{xen:phrase available_upgrades}</h3>
	<ul>
	<xen:foreach loop="$purchased" value="$upgrade">
		<xen:if is="{$upgrade.can_gift}">
		<li class="primaryContent upgrade">
				<div action="{$payPalUrl}" method="post" class="upgradeForm">
					<div class="cost">{$upgrade.costPhrase}</div>
					<a href="{xen:link full:account/upgrades/gift, '', 'upgrade_id={$upgrade.user_upgrade_id}'}" class="button OverlayTrigger">{xen:phrase nixfifty_giftupgrades_gift}</a>
				</div>

				<div class="upgradeMain">
					<h4 class="title">{$upgrade.title}</h4>
					<xen:if is="{$upgrade.description}">
						<div class="description">{xen:raw $upgrade.description}</div>
					</xen:if>
				</div>
		</li>
		</xen:if>
	</xen:foreach>
	</ul>
</div>
</xen:if>
$0]]></replace>
  </modification>
  <modification type="public" template="bdpaygate_account_upgrades_form" modification_key="nixfifty_giftUpgrades_giftUpgradePaygate" description="Adds a gift button to available upgrades when Paygates is active." execution_order="9" enabled="1" action="str_replace">
    <find><![CDATA[<xen:contentcheck>
			<xen:foreach loop="$upgrade.paymentForms" key="$processorId" value="$form">
				<div id="{$processorId}">{xen:raw $form}</div>
			</xen:foreach>
		</xen:contentcheck>]]></find>
    <replace><![CDATA[$0
<xen:if is="{$upgrade.can_gift}">
<a href="{xen:link full:account/upgrades/gift, '', 'upgrade_id={$upgrade.user_upgrade_id}'}" class="button OverlayTrigger">{xen:phrase nixfifty_giftupgrades_gift}</a>
</xen:if>]]></replace>
  </modification>
  <modification type="public" template="core_button.less" modification_key="nf_giftupgrades_core_button" description="Add a gift icon to buttons." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[&--purchase	    { .m-buttonIcon(@fa-var-credit-card, 1.11em); }]]></find>
    <replace><![CDATA[$0
&--nfgift	    { .m-buttonIcon(@fa-var-gift, .8em); }]]></replace>
  </modification>
  <modification type="public" template="forum_list" modification_key="forum_list_gifted_posts" description="Inject list of recently gifted posts" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:if is="{$threads}">]]></find>
    <replace><![CDATA[<xen:include template="forum_list_gifted_posts" />
$0]]></replace>
  </modification>
  <modification type="admin" template="helper_criteria_user" modification_key="GiftUpgradesHelperCriteriaUserContent" description="Adds additional criteria to user criteria form." execution_order="10" enabled="0" action="preg_replace">
    <find><![CDATA[/<xen:hook name="user_criteria_content">(.*?)<\/xen:hook>/is]]></find>
    <replace><![CDATA[$0
	<xen:include template="nixfifty_giftupgrades_helper_criteria_user" />]]></replace>
  </modification>
  <modification type="public" template="member_card" modification_key="nf_giftupgrades_member_card_controls" description="Adds gift controls to member cards" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:follow user="$user" class="Tooltip" />]]></find>
    <replace><![CDATA[<xen:include template="nf_member_card_gift_controls" />
$0]]></replace>
  </modification>
  <modification type="public" template="member_view" modification_key="nf_giftupgrades_member_view_controls" description="Adds gift controls to member profiles" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:follow user="$user" title="" tag="li" />]]></find>
    <replace><![CDATA[<xen:include template="nf_member_view_gift_controls" />
$0]]></replace>
  </modification>
  <modification type="public" template="message" modification_key="nf_giftupgrades_message_class" description="Adds gifted class to post messages" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[{xen:if '{$message.is_staff}', 'staff'}]]></find>
    <replace><![CDATA[$0 {xen:if '{$message.nf_gifts}', 'nf_gifted'}]]></replace>
  </modification>
  <modification type="public" template="message" modification_key="nf_giftupgrades_message_css" description="Adds gift CSS requirement to messages" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:require css="message.css" />]]></find>
    <replace><![CDATA[$0
<xen:require css="nf_giftupgrades.css" />]]></replace>
  </modification>
  <modification type="public" template="message_simple" modification_key="nf_giftupgrades_message_simple_class" description="Adds gifted class to profile post messages" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[{xen:if '{$message.is_staff}', 'staff'}]]></find>
    <replace><![CDATA[$0 {xen:if '{$message.nf_gifts}', 'nf_gifted'}]]></replace>
  </modification>
  <modification type="public" template="message_simple" modification_key="nf_giftupgrades_message_simple_css" description="Adds gift CSS requirement to simple messages" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:require css="message_simple.css" />]]></find>
    <replace><![CDATA[$0
<xen:require css="nf_giftupgrades.css" />]]></replace>
  </modification>
  <modification type="public" template="nf_calendar_event_description" modification_key="nf_giftupgrades_event_controls" description="Adds gift controls to events" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[#(<xen:if is="{\$event.canLikeEvent}".*</xen:if>)#sU]]></find>
    <replace><![CDATA[$0
<xen:include template="nf_giftupgrades_event_gift_controls" />]]></replace>
  </modification>
  <modification type="public" template="post" modification_key="nf_giftupgrades_post_controls" description="Adds gift controls to posts" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[#(<xen:if is="{\$post.canLike}".*</xen:if>)#sU]]></find>
    <replace><![CDATA[$0
<xen:include template="nf_post_gift_controls" />]]></replace>
  </modification>
  <modification type="public" template="profile_post" modification_key="nf_giftupgrades_profile_post_controls" description="Adds gift controls to profile posts" execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xen:if is="{$profilePost.canLike}">
						<a href="{xen:link 'profile-posts/like', $profilePost}" class="LikeLink item control {xen:if $profilePost.like_date, unlike, like}" data-container="#likes-wp-{$profilePost.profile_post_id}"><span></span><span class="LikeLabel">{xen:if $profilePost.like_date, {xen:phrase unlike}, {xen:phrase like}}</span></a>
					</xen:if>]]></find>
    <replace><![CDATA[$0
<xen:include template="nf_profile_post_gift_controls" />]]></replace>
  </modification>
  <modification type="admin" template="user_extra" modification_key="nixfifty_giftUpgrades_giftedBy" description="Displays giftee information if the upgrade was gifted." execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[#(<xf:datarow rowclass="dataList-row--noHover">.*<xf:cell>{\$upgrade\.Upgrade\.title})(<\/xf:cell>)#s]]></find>
    <replace><![CDATA[<xf:set var="{$_upgrade}" value="{$upgrade}" />
$1 <xf:include template="nixfifty_giftupgrades_giftedby_label" /> $2]]></replace>
  </modification>
  <modification type="admin" template="user_upgrade_active_list" modification_key="nf_giftupgrades_user_upgrade_active_list" description="Displays giftee information if the upgrade was gifted." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:username user="{$activeUpgrade.User}" defaultname="{{ phrase('unknown_user') }}" href="{{ link('users/edit', $activeUpgrade.User) }}" />]]></find>
    <replace><![CDATA[<xf:set var="{$_upgrade}" value="{$activeUpgrade}" />
$0 <xf:include template="nixfifty_giftupgrades_giftedby_label" />]]></replace>
  </modification>
  <modification type="admin" template="user_upgrade_edit" modification_key="nixfifty_giftUpgrades_canBeGifted" description="Adds a checkbox to set whether an upgrade is eligible for gifting." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:option name="can_purchase" selected="$upgrade.can_purchase">{{ phrase('can_be_purchased') }}</xf:option>]]></find>
    <replace><![CDATA[$0
<xf:option name="can_gift" selected="$upgrade.can_gift">{{ phrase('nixfifty_giftupgrades_can_be_gifted') }}</xf:option>]]></replace>
  </modification>
  <modification type="admin" template="user_upgrade_expired_list" modification_key="nf_giftupgrades_user_upgrade_expired_list" description="Displays giftee information if the upgrade was gifted." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:username user="{$expiredUpgrade.User}" defaultname="{{ phrase('unknown_user') }}" href="{{ link('users/edit', $expiredUpgrade.User) }}" />]]></find>
    <replace><![CDATA[<xf:set var="{$_upgrade}" value="{$expiredUpgrade}" />
$0 <xf:include template="nixfifty_giftupgrades_giftedby_label" />]]></replace>
  </modification>
  <modification type="admin" template="user_upgrade_list" modification_key="nf_giftupgrades_user_upgrade_list" description="Displays giftee information if the upgrade was gifted." execution_order="10" enabled="1" action="str_replace">
    <find><![CDATA[<xf:username user="{$upgrade.User}" defaultname="{{ phrase('unknown_user') }}" href="{{ link('users/edit', $upgrade.User) }}" />]]></find>
    <replace><![CDATA[<xf:set var="{$_upgrade}" value="{$upgrade}" />
$0 <xf:include template="nixfifty_giftupgrades_giftedby_label" />]]></replace>
  </modification>
  <modification type="public" template="xengallery_media_view" modification_key="nf_giftupgrades_xengallery_media_view" description="Adds gift controls to media" execution_order="10" enabled="1" action="preg_replace">
    <find><![CDATA[#(<xen:if is="{\$canLikeMedia}".*</xen:if>)#sU]]></find>
    <replace><![CDATA[$0
<xen:include template="nf_giftupgrades_media_gift_controls" />]]></replace>
  </modification>
</template_modifications>
